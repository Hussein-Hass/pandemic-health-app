<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Subscription - Pandemic Detection System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/subscription.css">
</head>
<body>
    <header class="site-header">
        <div class="header-inner">
            <a class="brand" href="dashboard.html">‚Üê Back to Dashboard</a>
        </div>
    </header>

    <main class="subscription-container" role="main">
        <header class="page-header" style="text-align:center; margin-bottom:30px;">
            <h1>Upgrade Your Protection</h1>
            <p class="lead">Unlock AI Analysis and Real-Time Alerts</p>
        </header>

        <section class="plans card">
            <div class="plan-grid">
                <article class="plan">
                    <h3>Basic Citizen</h3>
                    <p class="price"><strong>Free</strong></p>
                    <ul class="plan-features">
                        <li>‚úÖ Access to Dashboard</li>
                        <li>‚úÖ View General Alerts</li>
                        <li>‚ùå No AI Symptom Analysis</li>
                        <li>‚ùå No Risk Predictions</li>
                    </ul>
                    <button class="btn ghost" disabled>Current Plan</button>
                </article>

                <article class="plan featured" style="border: 2px solid #05668d;">
                    <div class="badge" style="background:#05668d; color:white; padding:5px 10px; border-radius:15px; position:absolute; top:-10px; right:20px;">Recommended</div>
                    <h3>Premium Shield</h3>
                    <p class="price"><strong>‚Ç¶5,000</strong><span>/year</span></p>
                    <ul class="plan-features">
                        <li>‚úÖ <strong>Unlimited AI Analysis</strong></li>
                        <li>‚úÖ <strong>24/7 Monitoring</strong></li>
                        <li>‚úÖ Priority NCDC Alerts</li>
                    </ul>
                    <button class="btn primary select-plan" id="upgradeBtn">‚ö° Upgrade Now</button>
                </article>
            </div>
        </section>
    </main>

    <div id="confirmModal" class="modal hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center;">
        <div class="modal-card" style="background:white; padding:30px; border-radius:12px; max-width:400px; text-align:center;">
            <h3>Confirm Payment</h3>
            <p>You are about to upgrade to the <strong>Premium Shield</strong> plan.</p>
            <p style="font-size:0.9rem; color:#666; margin:15px 0;">(This is a demo. No real money will be deducted.)</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button id="processPayment" class="btn primary">üí≥ Pay ‚Ç¶5,000</button>
                <button id="cancelPayment" class="btn ghost">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHTTbLJbKUbvIj7amzeCmsRMKT5UtaknE",
            authDomain: "pandemic-health.firebaseapp.com",
            projectId: "pandemic-health",
            storageBucket: "pandemic-health.firebasestorage.app",
            messagingSenderId: "80746170325",
            appId: "1:80746170325:web:2ec82c7c1711a38be85f5c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const upgradeBtn = document.getElementById('upgradeBtn');
        const modal = document.getElementById('confirmModal');
        const payBtn = document.getElementById('processPayment');
        const cancelBtn = document.getElementById('cancelPayment');

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) { currentUser = user; }
            else { window.location.href = 'login.html'; }
        });

        // Show Modal
        upgradeBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
        });

        // Hide Modal
        cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // PROCESS PAYMENT (Update Database)
        payBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            
            payBtn.textContent = "Processing...";
            
            try {
                // This is the Business Logic: Update plan to 'premium'
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, {
                    plan: "premium",
                    updatedAt: new Date().toISOString()
                });
                
                alert("üéâ Payment Successful! You are now a Premium User.");
                window.location.href = "ai_detection.html"; // Redirect to AI page
            } catch (error) {
                console.error("Error updating plan:", error);
                alert("Transaction failed. Try again.");
                payBtn.textContent = "üí≥ Pay ‚Ç¶5,000";
            }
        });
    </script>
</body>
</html>