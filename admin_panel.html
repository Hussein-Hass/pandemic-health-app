<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel | Pandemic Health</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/admin.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
      .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
      .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
      .full-width { grid-column: span 2; }
      @media(max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
      
      .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; color: white;}
      .badge.high { background: #d32f2f; }
      .badge.medium { background: #f57c00; }
      .badge.low { background: #388e3c; }

      /* Map Container */
      #map { height: 300px; width: 100%; border-radius: 10px; z-index: 1; }
  </style>
</head>
<body>
  <div class="admin-container">
    <aside class="sidebar">
      <h2>Admin Panel</h2>
      <nav>
        <ul>
          <li><a href="#stats">üìä Analytics</a></li>
          <li><a href="#mapSection">üåç Live Map</a></li>
          <li><a href="#broadcast">üì¢ Alerts</a></li>
          <li><a href="#aiResults">üè• Reports</a></li>
          <li><a href="#manageUsers">üë• Users</a></li>
          <li><a href="#" id="logoutBtn">üö™ Logout</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      
      <section id="stats">
          <h3>Live Outbreak Analytics</h3>
          <div class="stats-grid">
              <div class="chart-box">
                  <canvas id="riskChart"></canvas>
                  <p style="text-align:center; margin-top:10px; font-size:0.9rem; color:#666;">Risk Distribution</p>
              </div>
              <div class="chart-box">
                  <canvas id="locationChart"></canvas>
                  <p style="text-align:center; margin-top:10px; font-size:0.9rem; color:#666;">Top Affected Cities</p>
              </div>
          </div>
      </section>

      <section id="mapSection">
          <h3>Geospatial Surveillance</h3>
          <div class="chart-box">
              <div id="map"></div>
          </div>
      </section>

      <section id="broadcast">
        <h3>üì¢ Send Emergency Broadcast</h3>
        <div class="chart-box">
            <form id="broadcastForm">
                <input id="msgTitle" type="text" placeholder="Title (e.g. Cholera Alert)" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px;" required>
                <textarea id="msgBody" rows="2" placeholder="Message details..." style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px;" required></textarea>
                <button type="submit" class="btn primary">üöÄ Send Broadcast</button>
                <span id="broadcastMsg" style="margin-left:10px; font-size:0.9rem;"></span>
            </form>
        </div>
      </section>

      <section id="aiResults">
        <h3>Incoming AI Reports</h3>
        <div class="chart-box" style="overflow-x:auto;">
            <table id="aiResultsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>User</th>
                  <th>Symptoms</th>
                  <th>Location</th>
                  <th>Risk Score</th>
                </tr>
              </thead>
              <tbody><tr><td colspan="5">Loading data...</td></tr></tbody>
            </table>
        </div>
      </section>

      <section id="manageUsers">
        <h3>Registered Users</h3>
        <div class="chart-box" style="overflow-x:auto;">
            <table id="usersTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Joined</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
        </div>
      </section>

    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHTTbLJbKUbvIj7amzeCmsRMKT5UtaknE",
      authDomain: "pandemic-health.firebaseapp.com",
      projectId: "pandemic-health",
      storageBucket: "pandemic-health.firebasestorage.app",
      messagingSenderId: "80746170325",
      appId: "1:80746170325:web:2ec82c7c1711a38be85f5c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- MAP INITIALIZATION ---
    // Default view: Nigeria
    const map = L.map('map').setView([9.0820, 8.6753], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Hardcoded Coordinates for Demo (Since we only store City Names)
    const cityCoords = {
        "lagos": [6.5244, 3.3792],
        "abuja": [9.0765, 7.3986],
        "kano": [12.0022, 8.5919],
        "rivers": [4.8156, 7.0498],
        "ibadan": [7.3775, 3.9470]
    };

    // --- CHART VARIABLES ---
    let riskChartInstance = null;
    let locationChartInstance = null;

    // --- FETCH DATA & UPDATE DASHBOARD ---
    async function loadDashboardData() {
        try {
            // A. Load AI Results
            const aiRef = collection(db, 'ai_results');
            const aiSnap = await getDocs(query(aiRef, orderBy('timestamp', 'desc')));
            
            const aiTable = document.querySelector('#aiResultsTable tbody');
            aiTable.innerHTML = '';
            
            let highRiskCount = 0;
            let medRiskCount = 0;
            let lowRiskCount = 0;
            let locationCounts = {};

            // Clear Map Markers
            map.eachLayer((layer) => {
                if(layer instanceof L.Marker) { map.removeLayer(layer); }
            });

            aiSnap.forEach(doc => {
                const data = doc.data();
                
                // --- THE FIX FOR "INVALID DATE" ---
                let dateStr = "N/A";
                // Check if it is a Firestore Timestamp object (it has .toDate())
                if (data.timestamp && typeof data.timestamp.toDate === 'function') {
                    dateStr = data.timestamp.toDate().toLocaleDateString();
                } 
                // Check if it is a standard JS Date string/number
                else if (data.timestamp) {
                    try {
                        dateStr = new Date(data.timestamp).toLocaleDateString();
                    } catch(e) { dateStr = "Invalid Format"; }
                }

                // 2. Stats
                let badgeClass = 'low';
                if(data.score > 75) { badgeClass = 'high'; highRiskCount++; }
                else if(data.score > 40) { badgeClass = 'medium'; medRiskCount++; }
                else { lowRiskCount++; }

                // 3. Location & Map
                const loc = (data.location || 'Unknown').toLowerCase();
                locationCounts[loc] = (locationCounts[loc] || 0) + 1;

                // If city is in our coord list, drop a pin
                if (cityCoords[loc]) {
                    L.marker(cityCoords[loc]).addTo(map)
                        .bindPopup(`<b>${loc.toUpperCase()}</b><br>Risk Score: ${data.score}%`);
                }

                // 4. Fill Table
                const row = `
                <tr>
                    <td>${dateStr}</td>
                    <td>${data.userName}</td>
                    <td>${data.symptoms}</td>
                    <td>${data.location}</td>
                    <td><span class="badge ${badgeClass}">${data.score}% (${data.riskLevel})</span></td>
                </tr>`;
                aiTable.innerHTML += row;
            });

            if (aiSnap.empty) {
                aiTable.innerHTML = '<tr><td colspan="5" style="text-align:center;">No AI reports found yet. Go to AI Detection page to create one.</td></tr>';
            }

            // B. Render Charts
            renderCharts(highRiskCount, medRiskCount, lowRiskCount, locationCounts);

            // C. Load Users
            const userRef = collection(db, 'users');
            const userSnap = await getDocs(userRef);
            const userTable = document.querySelector('#usersTable tbody');
            userTable.innerHTML = '';
            
            userSnap.forEach(doc => {
                const u = doc.data();
                // Safe date for users too
                let joinDate = "N/A";
                if(u.createdAt) joinDate = new Date(u.createdAt).toLocaleDateString();

                userTable.innerHTML += `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.role || 'user'}</td>
                    <td>${joinDate}</td>
                </tr>`;
            });
        } catch (error) {
            console.error("Dashboard Error:", error);
            // Don't leave the user hanging
            document.querySelector('#aiResultsTable tbody').innerHTML = `<tr><td colspan="5" style="color:red;">Error loading data. Check console.</td></tr>`;
        }
    }

    // --- CHART LOGIC ---
    function renderCharts(high, med, low, locData) {
        const ctxRisk = document.getElementById('riskChart').getContext('2d');
        const ctxLoc = document.getElementById('locationChart').getContext('2d');

        if(riskChartInstance) riskChartInstance.destroy();
        if(locationChartInstance) locationChartInstance.destroy();

        riskChartInstance = new Chart(ctxRisk, {
            type: 'doughnut',
            data: {
                labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                datasets: [{
                    data: [high, med, low],
                    backgroundColor: ['#d32f2f', '#f57c00', '#388e3c']
                }]
            }
        });

        locationChartInstance = new Chart(ctxLoc, {
            type: 'bar',
            data: {
                labels: Object.keys(locData),
                datasets: [{
                    label: 'Reports',
                    data: Object.values(locData),
                    backgroundColor: '#05668d'
                }]
            }
        });
    }

    // --- BROADCAST LOGIC ---
    document.getElementById('broadcastForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const t = document.getElementById('msgTitle').value;
        const b = document.getElementById('msgBody').value;
        const note = document.getElementById('broadcastMsg');
        
        try {
            await addDoc(collection(db, "notifications"), { title: t, message: b, timestamp: serverTimestamp() });
            note.textContent = "‚úÖ Sent!"; note.style.color = "green";
            e.target.reset();
        } catch (err) { console.error(err); note.textContent = "‚ùå Error"; }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = 'login.html');
    });

    // Initialize
    loadDashboardData();

  </script>
</body>
</html>